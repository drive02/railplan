<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RailPlan ‚Äî Tableau de Bord Ferroviaire</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0c10; --panel:#0f1318; --border:#1e2530;
    --accent:#f5a623; --accent2:#00d4aa; --accent3:#e84545;
    --text:#c8d0dc; --text-dim:#5a6474;
    --rail1:#f5a623; --rail2:#00d4aa; --rail3:#a78bfa;
    --font-mono:'Share Tech Mono',monospace;
    --font-display:'Bebas Neue',sans-serif;
    --font-body:'DM Sans',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh}
  body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none;z-index:9999}

  header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
  .logo{font-family:var(--font-display);font-size:2rem;letter-spacing:4px;color:var(--accent);text-shadow:0 0 20px rgba(245,166,35,.4)}
  .logo span{color:var(--text-dim);font-size:1rem;letter-spacing:2px;margin-left:10px;font-family:var(--font-mono);vertical-align:middle}
  .clock{font-family:var(--font-mono);font-size:1.4rem;color:var(--accent2);text-shadow:0 0 10px rgba(0,212,170,.3)}
  .header-actions{display:flex;gap:10px}

  .btn{font-family:var(--font-mono);font-size:.75rem;padding:8px 16px;border:1px solid;border-radius:2px;cursor:pointer;letter-spacing:1px;transition:all .2s;background:transparent;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
  .btn-primary{border-color:var(--accent);color:var(--accent)}
  .btn-primary:hover{background:var(--accent);color:var(--bg)}
  .btn-danger{border-color:var(--accent3);color:var(--accent3)}
  .btn-danger:hover{background:var(--accent3);color:white}
  .btn-success{border-color:var(--accent2);color:var(--accent2)}
  .btn-success:hover{background:var(--accent2);color:var(--bg)}
  .btn-csv{border-color:#4ade80;color:#4ade80}
  .btn-csv:hover{background:#4ade80;color:var(--bg)}

  .layout{display:grid;grid-template-columns:340px 1fr;height:calc(100vh - 60px)}
  .sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:20px}
  .section-title{font-family:var(--font-mono);font-size:.7rem;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:10px}

  .form-group{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
  label{font-size:.7rem;letter-spacing:1px;color:var(--text-dim);font-family:var(--font-mono)}
  input,select,textarea{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-body);font-size:.85rem;padding:8px 10px;border-radius:2px;outline:none;transition:border-color .2s;width:100%}
  input:focus,select:focus,textarea:focus{border-color:var(--accent)}
  select option{background:var(--panel)}

  .rail-indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
  .alert-box{background:rgba(232,69,69,.07);border:1px solid rgba(232,69,69,.2);border-radius:4px;padding:12px}
  .alert-status{display:flex;align-items:center;gap:8px;font-size:.8rem}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--accent3);animation:pulse 1.5s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

  .main{display:flex;flex-direction:column;overflow:hidden}
  .tabs{display:flex;background:var(--panel);border-bottom:1px solid var(--border);padding:0 20px}
  .tab{font-family:var(--font-mono);font-size:.75rem;letter-spacing:2px;padding:14px 20px;cursor:pointer;color:var(--text-dim);border-bottom:2px solid transparent;transition:all .2s}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
  .tab-content{display:none;flex:1;overflow-y:auto;padding:24px}
  .tab-content.active{display:block}

  .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
  .stat-card{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:16px;position:relative;overflow:hidden}
  .stat-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
  .stat-card.s1::before{background:var(--rail1)}.stat-card.s2::before{background:var(--rail2)}
  .stat-card.s3::before{background:var(--rail3)}.stat-card.s4::before{background:var(--accent3)}
  .stat-label{font-family:var(--font-mono);font-size:.65rem;letter-spacing:2px;color:var(--text-dim);margin-bottom:8px}
  .stat-value{font-family:var(--font-display);font-size:2.2rem;line-height:1}
  .stat-sub{font-size:.75rem;color:var(--text-dim);margin-top:4px}

  .rail-visual{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:20px;margin-bottom:24px}
  .rail-track{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  .rail-name{font-family:var(--font-mono);font-size:.8rem;width:80px;flex-shrink:0}
  .track-bar{flex:1;height:28px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:2px;position:relative;overflow:hidden}
  .train-block{position:absolute;top:2px;bottom:2px;border-radius:2px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-size:.6rem;letter-spacing:1px;white-space:nowrap;overflow:hidden;padding:0 6px;cursor:pointer;transition:filter .2s}
  .train-block:hover{filter:brightness(1.3)}

  /* Toolbar above table */
  .table-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
  .table-toolbar-left{display:flex;gap:10px;align-items:center}

  .trains-table{width:100%;border-collapse:collapse;font-size:.82rem}
  .trains-table th{font-family:var(--font-mono);font-size:.65rem;letter-spacing:2px;color:var(--text-dim);text-align:left;padding:10px 12px;border-bottom:1px solid var(--border)}
  .trains-table td{padding:12px;border-bottom:1px solid rgba(30,37,48,.5);vertical-align:middle}
  .trains-table tr:hover td{background:rgba(255,255,255,.02)}

  .badge{display:inline-block;font-family:var(--font-mono);font-size:.65rem;letter-spacing:1px;padding:3px 8px;border-radius:2px}
  .badge-orge{background:rgba(245,166,35,.15);color:var(--accent);border:1px solid rgba(245,166,35,.3)}
  .badge-ble{background:rgba(0,212,170,.1);color:var(--accent2);border:1px solid rgba(0,212,170,.2)}
  .badge-mais{background:rgba(167,139,250,.1);color:var(--rail3);border:1px solid rgba(167,139,250,.2)}
  .badge-colza{background:rgba(232,69,69,.1);color:var(--accent3);border:1px solid rgba(232,69,69,.2)}
  .badge-tournesol{background:rgba(255,200,0,.1);color:#ffc800;border:1px solid rgba(255,200,0,.2)}

  .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
  .status-en-route{background:var(--accent2);box-shadow:0 0 6px var(--accent2)}
  .status-planifie{background:var(--accent)}
  .status-arrive{background:var(--text-dim)}
  .status-alerte{background:var(--accent3);animation:pulse 1s infinite}

  .progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;width:80px}
  .progress-fill{height:100%;border-radius:2px}

  .alerts-list{display:flex;flex-direction:column;gap:10px}
  .alert-item{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:14px 16px;display:flex;gap:14px;align-items:flex-start}
  .alert-item.critical{border-left:3px solid var(--accent3)}
  .alert-item.warning{border-left:3px solid var(--accent)}
  .alert-item.info{border-left:3px solid var(--accent2)}
  .alert-icon{font-size:1.2rem}.alert-text{flex:1}
  .alert-title{font-weight:600;font-size:.85rem}
  .alert-desc{font-size:.78rem;color:var(--text-dim);margin-top:3px}
  .alert-time{font-family:var(--font-mono);font-size:.7rem;color:var(--text-dim)}

  .tonnage-bar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .tbar-label{width:100px;font-size:.78rem;color:var(--text-dim)}
  .tbar-track{flex:1;height:10px;background:var(--border);border-radius:2px;overflow:hidden}
  .tbar-fill{height:100%;border-radius:2px;transition:width 1s ease}
  .tbar-val{font-family:var(--font-mono);font-size:.75rem;width:60px;text-align:right}

  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;align-items:center;justify-content:center}
  .modal-overlay.open{display:flex}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:28px;width:480px;max-height:80vh;overflow-y:auto}
  .modal-title{font-family:var(--font-display);font-size:1.5rem;letter-spacing:3px;color:var(--accent);margin-bottom:20px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

  .toast{position:fixed;bottom:60px;right:20px;background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:12px 18px;font-family:var(--font-mono);font-size:.8rem;z-index:500;transform:translateY(80px);opacity:0;transition:all .3s}
  .toast.show{transform:none;opacity:1}
  .toast.success{border-left:3px solid var(--accent2);color:var(--accent2)}
  .toast.error{border-left:3px solid var(--accent3);color:var(--accent3)}

  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  .tab-content.active>*{animation:fadeIn .3s ease forwards}

  .ticker{background:rgba(245,166,35,.08);border-top:1px solid rgba(245,166,35,.2);padding:6px 0;overflow:hidden;white-space:nowrap;position:fixed;bottom:0;left:0;right:0;font-family:var(--font-mono);font-size:.72rem;color:var(--accent);z-index:50}
  .ticker-inner{display:inline-block;animation:scroll 40s linear infinite}
  @keyframes scroll{from{transform:translateX(100vw)}to{transform:translateX(-100%)}}
</style>
</head>
<body>

<header>
  <div class="logo">RAILPLAN <span>// GESTION FERROVIAIRE</span></div>
  <div class="clock" id="clock">--:--:--</div>
  <div class="header-actions">
    <button class="btn btn-csv" onclick="exportCSV()">‚¨á EXPORT CSV</button>
    <button class="btn btn-success" onclick="openModal()">+ NOUVEAU CONVOI</button>
    <button class="btn btn-primary" onclick="toggleTV()">üì∫ MODE TV</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div>
      <div class="section-title">‚ö° ALERTING EMAIL</div>
      <div class="alert-box">
        <div class="alert-status" style="margin-bottom:10px">
          <span class="dot"></span>
          <span style="font-size:.8rem">Alertes actives</span>
        </div>
        <div class="form-group">
          <label>EMAIL DESTINATAIRE</label>
          <input type="email" id="alertEmail" placeholder="email@exemple.com">
        </div>
        <div class="form-group">
          <label>D√âLAI ALERTE (min avant arriv√©e)</label>
          <input type="number" id="alertDelay" value="60" min="15" max="480">
        </div>
        <div class="form-group">
          <label>TYPE D'ALERTES</label>
          <select id="alertTypes">
            <option value="all">Toutes les alertes</option>
            <option value="arrival">Arriv√©e imminente</option>
            <option value="delay">Retards uniquement</option>
            <option value="critical">Critiques seulement</option>
          </select>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-danger" style="flex:1" onclick="saveAlertConfig()">SAUVEGARDER</button>
          <button class="btn btn-primary" style="flex:1" onclick="testAlert()">TEST EMAIL</button>
        </div>
      </div>
    </div>

    <div>
      <div class="section-title">üîç FILTRES</div>
      <div class="form-group">
        <label>LIGNE</label>
        <select id="filterRail" onchange="loadTrains()">
          <option value="all">Toutes les lignes</option>
          <option value="1">Ligne A ‚Äî Nord</option>
          <option value="2">Ligne B ‚Äî Est</option>
          <option value="3">Ligne C ‚Äî Ouest</option>
        </select>
      </div>
      <div class="form-group">
        <label>MARCHANDISE</label>
        <select id="filterCargo" onchange="loadTrains()">
          <option value="all">Toutes</option>
          <option value="Orge">Orge</option>
          <option value="Bl√©">Bl√©</option>
          <option value="Ma√Øs">Ma√Øs</option>
          <option value="Colza">Colza</option>
          <option value="Tournesol">Tournesol</option>
        </select>
      </div>
      <div class="form-group">
        <label>STATUT</label>
        <select id="filterStatus" onchange="loadTrains()">
          <option value="all">Tous</option>
          <option value="En route">En route</option>
          <option value="Planifi√©">Planifi√©</option>
          <option value="Arriv√©">Arriv√©</option>
          <option value="Alerte">Alerte</option>
        </select>
      </div>
    </div>

    <div>
      <div class="section-title">‚öñÔ∏è TONNAGE PAR MARCHANDISE</div>
      <div id="tonnageSummary"></div>
    </div>
  </aside>

  <main class="main">
    <div class="tabs">
      <div class="tab active" data-tab="overview" onclick="switchTab(this)">VUE G√âN√âRALE</div>
      <div class="tab" data-tab="trains" onclick="switchTab(this)">CONVOIS</div>
      <div class="tab" data-tab="timeline" onclick="switchTab(this)">TIMELINE</div>
      <div class="tab" data-tab="alerts" onclick="switchTab(this)">ALERTES</div>
    </div>

    <div class="tab-content active" id="tab-overview">
      <div class="stats-row" id="statsRow"></div>
      <div class="rail-visual">
        <div class="section-title">PLANNING DES VOIES ‚Äî AUJOURD'HUI</div>
        <div id="railTimeline"></div>
      </div>
      <div class="rail-visual">
        <div class="section-title">R√âPARTITION MARCHANDISES</div>
        <div id="cargoChart"></div>
      </div>
    </div>

    <div class="tab-content" id="tab-trains">
      <div class="table-toolbar">
        <div class="table-toolbar-left">
          <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--text-dim)" id="trainCount">‚Äî convois</span>
        </div>
        <button class="btn btn-csv" onclick="exportCSV()">‚¨á EXPORT CSV (FILTR√â)</button>
      </div>
      <table class="trains-table">
        <thead>
          <tr>
            <th>ID CONVOI</th><th>LIGNE</th><th>MARCHANDISE</th><th>TONNAGE</th>
            <th>CLIENT</th><th>D√âPART</th><th>ARRIV√âE</th><th>STATUT</th>
            <th>PROGRESS</th><th>ACTIONS</th>
          </tr>
        </thead>
        <tbody id="trainsBody"></tbody>
      </table>
    </div>

    <div class="tab-content" id="tab-timeline">
      <div class="rail-visual" id="fullTimeline"></div>
    </div>

    <div class="tab-content" id="tab-alerts">
      <div id="alertsList"></div>
    </div>
  </main>
</div>

<div class="ticker"><span class="ticker-inner" id="tickerText">Chargement...</span></div>
<div class="toast" id="toast"></div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-title">NOUVEAU CONVOI</div>
    <div class="form-group"><label>LIGNE DE RAIL</label>
      <select id="formRail">
        <option value="1">Ligne A ‚Äî Nord</option>
        <option value="2">Ligne B ‚Äî Est</option>
        <option value="3">Ligne C ‚Äî Ouest</option>
      </select>
    </div>
    <div class="form-group"><label>MARCHANDISE</label>
      <select id="formCargo">
        <option>Orge</option><option>Bl√©</option><option>Ma√Øs</option><option>Colza</option><option>Tournesol</option>
      </select>
    </div>
    <div class="form-group"><label>TONNAGE (t)</label>
      <input type="number" id="formTonnage" value="1200" min="100" max="9999">
    </div>
    <div class="form-group"><label>CLIENT / DESTINATAIRE</label>
      <input type="text" id="formClient" placeholder="Nom du client">
    </div>
    <div class="form-group"><label>DATE & HEURE DE D√âPART</label>
      <input type="datetime-local" id="formDepart">
    </div>
    <div class="form-group"><label>DATE & HEURE D'ARRIV√âE</label>
      <input type="datetime-local" id="formArrivee">
    </div>
    <div class="form-group"><label>NOTES</label>
      <textarea id="formNotes" rows="2" style="resize:vertical" placeholder="Notes..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="closeModal()">ANNULER</button>
      <button class="btn btn-success" onclick="addTrain()">CR√âER CONVOI</button>
    </div>
  </div>
</div>

<script>
const RAILS={1:{name:'Ligne A ‚Äî Nord',color:'#f5a623'},2:{name:'Ligne B ‚Äî Est',color:'#00d4aa'},3:{name:'Ligne C ‚Äî Ouest',color:'#a78bfa'}};
const CARGO_COLORS={Orge:'#f5a623',Bl√©:'#00d4aa',Ma√Øs:'#a78bfa',Colza:'#e84545',Tournesol:'#ffc800'};
let trainsData=[];

// Clock
setInterval(()=>{
  const n=new Date();
  document.getElementById('clock').textContent=
    n.toLocaleDateString('fr-FR')+' '+n.toLocaleTimeString('fr-FR');
},1000);

// Toast
function toast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+type+' show';
  setTimeout(()=>t.className='toast',3000);
}

// Helpers
function fmtDate(s){if(!s)return'‚Äî';const d=new Date(s);return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}
function getProgress(t){const n=new Date(),dep=new Date(t.depart),arr=new Date(t.arrivee);if(n<dep)return 0;if(n>arr)return 100;return Math.round((n-dep)/(arr-dep)*100)}
function cargoClass(c){return'badge badge-'+({Orge:'orge',Bl√©:'ble',Ma√Øs:'mais',Colza:'colza',Tournesol:'tournesol'}[c]||'orge')}
function statusHTML(s){return`<span class="status-dot status-${({' En route':'en-route',Planifi√©:'planifie',Arriv√©:'arrive',Alerte:'alerte'}[s]||'planifie')}"></span>${s}`}
function getFilters(){return{rail:document.getElementById('filterRail').value,cargo:document.getElementById('filterCargo').value,status:document.getElementById('filterStatus').value}}

// API
async function api(url,opts={}){
  const r=await fetch(url,{headers:{'Content-Type':'application/json'},...opts});
  return r.json();
}

// Load trains
async function loadTrains(){
  const{rail,cargo,status}=getFilters();
  const params=new URLSearchParams();
  if(rail!=='all')params.set('rail',rail);
  if(cargo!=='all')params.set('cargo',cargo);
  if(status!=='all')params.set('status',status);
  trainsData=await api('/api/trains?'+params);
  renderAll();
}

// Export CSV
function exportCSV(){
  const{rail,cargo,status}=getFilters();
  const params=new URLSearchParams();
  if(rail!=='all')params.set('rail',rail);
  if(cargo!=='all')params.set('cargo',cargo);
  if(status!=='all')params.set('status',status);
  window.location.href='/api/export/csv?'+params;
  toast('üì• Export CSV t√©l√©charg√© !');
}

// Stats
async function renderStats(){
  const s=await api('/api/stats');
  document.getElementById('statsRow').innerHTML=`
    <div class="stat-card s1"><div class="stat-label">EN ROUTE</div><div class="stat-value" style="color:var(--accent2)">${s.en_route}</div><div class="stat-sub">convois actifs</div></div>
    <div class="stat-card s2"><div class="stat-label">PLANIFI√âS</div><div class="stat-value" style="color:var(--accent)">${s.planifie}</div><div class="stat-sub">convois pr√©vus</div></div>
    <div class="stat-card s3"><div class="stat-label">TONNAGE TOTAL</div><div class="stat-value" style="color:var(--rail3)">${(s.tonnage_total/1000).toFixed(1)}k</div><div class="stat-sub">tonnes</div></div>
    <div class="stat-card s4"><div class="stat-label">ALERTES</div><div class="stat-value" style="color:var(--accent3)">${s.alerte}</div><div class="stat-sub">n√©cessitent attention</div></div>`;
}

// Rail Timeline
function renderRailTimeline(){
  const now=new Date(),dayStart=new Date(now);dayStart.setHours(0,0,0,0);
  const dayEnd=new Date(now);dayEnd.setHours(24,0,0,0);
  const span=dayEnd-dayStart;
  let html='';
  [1,2,3].forEach(r=>{
    const rail=RAILS[r];
    const rt=trainsData.filter(t=>t.rail===r);
    let blocks=rt.map(t=>{
      const dep=new Date(t.depart),arr=new Date(t.arrivee);
      const left=Math.max(0,(dep-dayStart)/span*100);
      const width=Math.max(1,(arr-dep)/span*100);
      return`<div class="train-block" style="left:${left}%;width:${Math.min(width,100-left)}%;background:${rail.color};opacity:${t.status==='Arriv√©'?.4:1};color:#000" title="${t.train_id} | ${t.cargo} ${t.tonnage}t | ${fmtDate(t.depart)} ‚Üí ${fmtDate(t.arrivee)}">${t.train_id}</div>`;
    }).join('');
    const nowPct=Math.max(0,Math.min(100,(now-dayStart)/span*100));
    html+=`<div class="rail-track"><div class="rail-name" style="color:${rail.color}"><span class="rail-indicator" style="background:${rail.color}"></span>${rail.name.split('‚Äî')[0]}</div><div class="track-bar">${blocks}<div style="position:absolute;left:${nowPct}%;top:0;bottom:0;width:2px;background:rgba(255,255,255,.3);z-index:10"></div></div></div>`;
  });
  html+=`<div style="display:flex;margin-left:92px;font-family:var(--font-mono);font-size:.6rem;color:var(--text-dim);margin-top:4px">${Array.from({length:7},(_,i)=>`<div style="flex:1">${String(i*4).padStart(2,'0')}:00</div>`).join('')}</div>`;
  document.getElementById('railTimeline').innerHTML=html;
}

// Cargo chart
function renderCargoChart(){
  const totals={};
  trainsData.forEach(t=>{totals[t.cargo]=(totals[t.cargo]||0)+t.tonnage});
  const max=Math.max(...Object.values(totals),1);
  document.getElementById('cargoChart').innerHTML=Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`
    <div class="tonnage-bar"><div class="tbar-label">${c}</div><div class="tbar-track"><div class="tbar-fill" style="width:${Math.round(v/max*100)}%;background:${CARGO_COLORS[c]||'#888'}"></div></div><div class="tbar-val" style="color:${CARGO_COLORS[c]||'#888'}">${v.toLocaleString()}t</div></div>`).join('')||'<p style="color:var(--text-dim);font-size:.8rem">Aucune donn√©e</p>';
}

// Tonnage sidebar
function renderTonnage(){
  const totals={};
  trainsData.forEach(t=>{totals[t.cargo]=(totals[t.cargo]||0)+t.tonnage});
  const max=Math.max(...Object.values(totals),1);
  document.getElementById('tonnageSummary').innerHTML=Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`
    <div class="tonnage-bar"><div class="tbar-label" style="font-size:.75rem">${c}</div><div class="tbar-track"><div class="tbar-fill" style="width:${Math.round(v/max*100)}%;background:${CARGO_COLORS[c]||'#888'}"></div></div><div class="tbar-val" style="color:${CARGO_COLORS[c]||'#888'};font-size:.7rem">${v.toLocaleString()}t</div></div>`).join('')||'<p style="color:var(--text-dim);font-size:.75rem">Aucun convoi</p>';
}

// Trains table
function renderTrains(){
  document.getElementById('trainCount').textContent=`${trainsData.length} convoi${trainsData.length>1?'s':''}`;
  document.getElementById('trainsBody').innerHTML=trainsData.map(t=>{
    const prog=getProgress(t);
    const rc=RAILS[t.rail]?.color||'#888';
    return`<tr>
      <td><span style="font-family:var(--font-mono);color:${rc}">${t.train_id}</span></td>
      <td><span class="rail-indicator" style="background:${rc}"></span>${RAILS[t.rail]?.name.split('‚Äî')[0]||''}</td>
      <td><span class="${cargoClass(t.cargo)}">${t.cargo}</span></td>
      <td><b style="font-family:var(--font-mono)">${t.tonnage.toLocaleString()}</b> <span style="color:var(--text-dim);font-size:.75rem">t</span></td>
      <td style="font-size:.8rem;color:var(--text-dim)">${t.client}</td>
      <td style="font-family:var(--font-mono);font-size:.78rem">${fmtDate(t.depart)}</td>
      <td style="font-family:var(--font-mono);font-size:.78rem">${fmtDate(t.arrivee)}</td>
      <td>${statusHTML(t.status)}</td>
      <td><div class="progress-bar"><div class="progress-fill" style="width:${prog}%;background:${rc}"></div></div><div style="font-family:var(--font-mono);font-size:.65rem;color:var(--text-dim);margin-top:2px">${prog}%</div></td>
      <td><button class="btn btn-danger" style="font-size:.6rem;padding:4px 8px" onclick="deleteTrain(${t.id})">‚úï</button></td>
    </tr>`;
  }).join('')||'<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-dim)">Aucun convoi trouv√©</td></tr>';
}

// Full timeline
function renderFullTimeline(){
  const now=new Date(),refStart=new Date(now);refStart.setHours(0,0,0,0);
  const refEnd=new Date(refStart);refEnd.setHours(48,0,0,0);
  const span=refEnd-refStart;
  let html=`<div class="section-title">PLANNING D√âTAILL√â ‚Äî 48H</div>`;
  html+=`<div style="margin-left:180px;display:flex;font-family:var(--font-mono);font-size:.6rem;color:var(--text-dim);margin-bottom:8px">${Array.from({length:9},(_,i)=>{const d=new Date(refStart);d.setHours(i*6);return`<div style="flex:1">${d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})} ${String(i*6%24).padStart(2,'0')}h</div>`}).join('')}</div>`;
  trainsData.forEach(t=>{
    const dep=new Date(t.depart),arr=new Date(t.arrivee),rc=RAILS[t.rail]?.color||'#888';
    const left=Math.max(0,(dep-refStart)/span*100),width=Math.max(.5,(arr-dep)/span*100);
    html+=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
      <div style="width:168px;flex-shrink:0;font-size:.78rem"><span style="font-family:var(--font-mono);color:${rc}">${t.train_id}</span><br><span style="color:var(--text-dim);font-size:.7rem">${t.client}</span></div>
      <div style="flex:1;height:32px;background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:2px;position:relative;overflow:hidden">
        <div style="position:absolute;left:${left}%;width:${Math.min(width,100-left)}%;top:2px;bottom:2px;background:${rc};border-radius:2px;display:flex;align-items:center;padding:0 6px;font-family:var(--font-mono);font-size:.62rem;color:#000;white-space:nowrap;overflow:hidden">${t.cargo} ¬∑ ${t.tonnage}t</div>
      </div></div>`;
  });
  document.getElementById('fullTimeline').innerHTML=html||'<p style="color:var(--text-dim)">Aucun convoi</p>';
}

// Alerts
function renderAlerts(){
  const now=new Date();
  const items=[
    ...trainsData.filter(t=>t.status==='Alerte').map(t=>({type:'critical',icon:'üö®',title:`Retard signal√© ‚Äî ${t.train_id}`,desc:`${t.cargo} (${t.tonnage}t) | ${t.client} | ${t.notes||'Cause inconnue'}`,time:'Maintenant'})),
    ...trainsData.filter(t=>{const diff=(new Date(t.arrivee)-now)/60000;return diff>0&&diff<90&&t.status!=='Arriv√©'}).map(t=>{const diff=Math.round((new Date(t.arrivee)-now)/60000);return{type:'warning',icon:'‚è∞',title:`Arriv√©e imminente ‚Äî ${t.train_id}`,desc:`${t.cargo} (${t.tonnage}t) pour ${t.client} dans ${diff} min`,time:fmtDate(t.arrivee)}}),
    {type:'info',icon:'‚ÑπÔ∏è',title:'Syst√®me actif',desc:`${trainsData.length} convoi(s) en base`,time:'Syst√®me'}
  ];
  document.getElementById('alertsList').innerHTML=`<div class="alerts-list">${items.map(a=>`<div class="alert-item ${a.type}"><div class="alert-icon">${a.icon}</div><div class="alert-text"><div class="alert-title">${a.title}</div><div class="alert-desc">${a.desc}</div></div><div class="alert-time">${a.time}</div></div>`).join('')}</div>`;
}

// Ticker
function renderTicker(){
  const active=trainsData.filter(t=>t.status==='En route'||t.status==='Alerte');
  document.getElementById('tickerText').textContent=active.length?active.map(t=>`‚ñ∂ ${t.train_id} | ${RAILS[t.rail]?.name} | ${t.cargo} ${t.tonnage}t ‚Üí ${fmtDate(t.arrivee)} | ${t.client}`).join('    ///    '):'‚ñ∂ Aucun convoi en circulation';
}

function renderAll(){renderStats();renderRailTimeline();renderCargoChart();renderTonnage();renderTrains();renderAlerts();renderTicker();renderFullTimeline()}

// Tabs
function switchTab(el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-'+el.dataset.tab).classList.add('active');
}

// Modal
function openModal(){
  const n=new Date(),fmt=d=>d.toISOString().slice(0,16);
  document.getElementById('formDepart').value=fmt(n);
  document.getElementById('formArrivee').value=fmt(new Date(n.getTime()+6*3600000));
  document.getElementById('formClient').value='';
  document.getElementById('formNotes').value='';
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open')}

async function addTrain(){
  const depart=document.getElementById('formDepart').value;
  const arrivee=document.getElementById('formArrivee').value;
  if(!depart||!arrivee){toast('Renseignez les dates','error');return}
  if(new Date(arrivee)<=new Date(depart)){toast('Arriv√©e doit √™tre apr√®s d√©part','error');return}
  await api('/api/trains',{method:'POST',body:JSON.stringify({
    rail:document.getElementById('formRail').value,
    cargo:document.getElementById('formCargo').value,
    tonnage:document.getElementById('formTonnage').value,
    client:document.getElementById('formClient').value||'Client inconnu',
    depart,arrivee,
    notes:document.getElementById('formNotes').value
  })});
  closeModal();await loadTrains();toast('‚úÖ Convoi cr√©√© !');
}

async function deleteTrain(id){
  if(!confirm('Supprimer ce convoi ?'))return;
  await api('/api/trains/'+id,{method:'DELETE'});
  await loadTrains();toast('Convoi supprim√©');
}

// Alert config
async function saveAlertConfig(){
  await api('/api/alerts/config',{method:'POST',body:JSON.stringify({
    email:document.getElementById('alertEmail').value,
    delay_min:document.getElementById('alertDelay').value,
    alert_types:document.getElementById('alertTypes').value
  })});
  toast('‚úÖ Config email sauvegard√©e !');
}

async function testAlert(){
  const r=await api('/api/alerts/test',{method:'POST'});
  if(r.error)toast('Erreur: '+r.error,'error');
  else toast('üìß Email de test envoy√© √† '+r.to);
}

// TV mode
let tvMode=false;
function toggleTV(){
  tvMode=!tvMode;
  if(tvMode){document.body.requestFullscreen?.();document.querySelector('aside').style.display='none'}
  else{document.exitFullscreen?.();document.querySelector('aside').style.display=''}
}

// Init
(async function init(){
  const cfg=await api('/api/alerts/config');
  if(cfg.email)document.getElementById('alertEmail').value=cfg.email;
  if(cfg.delay_min)document.getElementById('alertDelay').value=cfg.delay_min;
  await loadTrains();
  setInterval(loadTrains,30000);
})();
</script>
</body>
</html>
