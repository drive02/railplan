<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RailPlan ‚Äî Tableau de Bord Ferroviaire</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23003d5c'/><rect x='4' y='10' width='20' height='12' rx='3' fill='%230099cc'/><rect x='6' y='12' width='5' height='4' rx='1' fill='white' opacity='.9'/><rect x='13' y='12' width='5' height='4' rx='1' fill='white' opacity='.9'/><rect x='4' y='19' width='20' height='2' fill='%23003d5c' opacity='.4'/><circle cx='8' cy='23' r='2.5' fill='%23d4a843'/><circle cx='8' cy='23' r='1.2' fill='%23003d5c'/><circle cx='18' cy='23' r='2.5' fill='%23d4a843'/><circle cx='18' cy='23' r='1.2' fill='%23003d5c'/><rect x='24' y='13' width='4' height='6' rx='1' fill='%23e05a1e'/><rect x='25' y='11' width='2' height='3' rx='1' fill='%236a8a9a'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#f0f4f8;
    --panel:#ffffff;
    --border:#c8daea;
    --accent:#005f8e;
    --accent2:#0099cc;
    --accent3:#e05a1e;
    --text:#1a3a4a;
    --text-dim:#6a8a9a;
    --rail1:#005f8e;
    --rail2:#0099cc;
    --rail3:#00b89c;
    --font-mono:'Share Tech Mono',monospace;
    --font-display:'Bebas Neue',sans-serif;
    --font-body:'DM Sans',sans-serif;
    --ocean-deep:#003d5c;
    --ocean-mid:#0077aa;
    --ocean-light:#e8f4fa;
    --wheat:#d4a843;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh;
    background-image: linear-gradient(180deg, #e8f4fa 0%, #f0f4f8 100%);
  }
  body::after{content:'';position:fixed;inset:0;
    background:
      radial-gradient(ellipse at 0% 100%, rgba(0,95,142,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 100% 0%, rgba(0,153,204,0.05) 0%, transparent 60%);
    pointer-events:none;z-index:0}

  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:0 28px;
    background: linear-gradient(135deg, var(--ocean-deep) 0%, var(--ocean-mid) 100%);
    border-bottom:3px solid var(--wheat);
    position:sticky;top:0;z-index:100;
    box-shadow: 0 2px 20px rgba(0,61,92,0.3);
    min-height:68px;
  }
  /* Vague d√©corative sous le header */
  header::after{
    content:'';position:absolute;bottom:-12px;left:0;right:0;height:12px;
    background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 12'%3E%3Cpath fill='%23d4a843' fill-opacity='0.6' d='M0,6 C240,12 480,0 720,6 C960,12 1200,0 1440,6 L1440,12 L0,12 Z'/%3E%3C/svg%3E") repeat-x;
    z-index:101;
  }
  .logo-area{display:flex;align-items:center;gap:16px}
  .logo-img{height:44px;filter:brightness(0) invert(1);}
  .logo-divider{width:1px;height:36px;background:rgba(255,255,255,0.25)}
  .logo{font-family:var(--font-display);font-size:1.8rem;letter-spacing:4px;color:#ffffff;}
  .logo span{color:rgba(255,255,255,0.6);font-size:.85rem;letter-spacing:2px;margin-left:8px;font-family:var(--font-mono);vertical-align:middle}
  .clock{font-family:var(--font-mono);font-size:1.2rem;color:rgba(255,255,255,0.9);
    background:rgba(255,255,255,0.1);padding:6px 14px;border-radius:4px;border:1px solid rgba(255,255,255,0.2)}
  .header-actions{display:flex;gap:10px}

  .btn{font-family:var(--font-mono);font-size:.75rem;padding:8px 16px;border:1px solid;border-radius:3px;cursor:pointer;letter-spacing:1px;transition:all .2s;background:rgba(255,255,255,0.15);text-decoration:none;display:inline-flex;align-items:center;gap:6px;color:white;border-color:rgba(255,255,255,0.4)}
  .btn:hover{background:rgba(255,255,255,0.3);border-color:white}
  .btn-primary{border-color:rgba(255,255,255,0.5);color:white}
  .btn-primary:hover{background:white;color:var(--ocean-deep)}
  .btn-danger{border-color:#ffaa88;color:#ffaa88}
  .btn-danger:hover{background:#ffaa88;color:white}
  .btn-success{border-color:#88ffcc;color:#88ffcc}
  .btn-success:hover{background:#88ffcc;color:var(--ocean-deep)}
  .btn-csv{border-color:#aaffdd;color:#aaffdd}
  .btn-csv:hover{background:#aaffdd;color:var(--ocean-deep)}

  .layout{display:grid;grid-template-columns:340px 1fr;height:calc(100vh - 68px)}
  .sidebar{background:linear-gradient(180deg,#ffffff 0%,#f5f9fc 100%);border-right:2px solid var(--border);overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:20px;box-shadow:2px 0 10px rgba(0,95,142,0.06)}
  .section-title{font-family:var(--font-mono);font-size:.7rem;letter-spacing:3px;color:var(--ocean-deep);text-transform:uppercase;padding-bottom:8px;border-bottom:2px solid var(--accent2);margin-bottom:10px;opacity:0.8}

  .form-group{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
  label{font-size:.7rem;letter-spacing:1px;color:var(--text-dim);font-family:var(--font-mono)}
  input,select,textarea{background:#f8fbfd;border:1px solid var(--border);color:var(--text);font-family:var(--font-body);font-size:.85rem;padding:8px 10px;border-radius:3px;outline:none;transition:all .2s;width:100%;box-shadow:inset 0 1px 3px rgba(0,95,142,0.06)}
  input:focus,select:focus,textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(0,153,204,0.15)}
  select option{background:white;color:var(--text)}
  label{color:var(--ocean-deep) !important;opacity:0.7}

  .rail-indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
  .alert-box{background:rgba(0,95,142,.06);border:1px solid rgba(0,95,142,.2);border-radius:4px;padding:12px}
  .alert-status{display:flex;align-items:center;gap:8px;font-size:.8rem}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--accent3);animation:pulse 1.5s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

  .main{display:flex;flex-direction:column;overflow:hidden}
  .tabs{display:flex;background:white;border-bottom:2px solid var(--border);padding:0 20px;box-shadow:0 2px 8px rgba(0,95,142,0.06)}
  .tab{font-family:var(--font-mono);font-size:.75rem;letter-spacing:2px;padding:14px 20px;cursor:pointer;color:var(--text-dim);border-bottom:2px solid transparent;transition:all .2s;margin-bottom:-2px}
  .tab.active{color:var(--ocean-deep);border-bottom-color:var(--accent);font-weight:600}
  .tab:hover:not(.active){color:var(--accent2);border-bottom-color:var(--accent2)}
  .tab-content{display:none;flex:1;overflow-y:auto;padding:24px;background:var(--ocean-light)}
  .tab-content.active{display:block}

  .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
  .stat-card{background:white;border:1px solid var(--border);border-radius:8px;padding:20px;position:relative;overflow:hidden;box-shadow:0 2px 12px rgba(0,95,142,0.08);transition:transform .2s,box-shadow .2s}
  .stat-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,95,142,0.14)}
  .stat-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:8px 0 0 8px}
  .stat-card::after{content:'';position:absolute;right:-20px;top:-20px;width:80px;height:80px;border-radius:50%;opacity:0.05}
  .stat-card.s1::before{background:var(--rail1)}.stat-card.s1::after{background:var(--rail1)}
  .stat-card.s2::before{background:var(--rail2)}.stat-card.s2::after{background:var(--rail2)}
  .stat-card.s3::before{background:var(--rail3)}.stat-card.s3::after{background:var(--rail3)}
  .stat-card.s4::before{background:var(--accent3)}.stat-card.s4::after{background:var(--accent3)}
  .stat-label{font-family:var(--font-mono);font-size:.65rem;letter-spacing:2px;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase}
  .stat-value{font-family:var(--font-display);font-size:2.4rem;line-height:1;color:var(--ocean-deep)}
  .stat-sub{font-size:.75rem;color:var(--text-dim);margin-top:4px}

  .rail-visual{background:white;border:1px solid var(--border);border-radius:8px;padding:20px;margin-bottom:24px;box-shadow:0 2px 12px rgba(0,95,142,0.06)}
  .rail-track{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  .rail-name{font-family:var(--font-mono);font-size:.8rem;width:80px;flex-shrink:0}
  .track-bar{flex:1;height:28px;background:#f0f6fa;border:1px solid var(--border);border-radius:3px;position:relative;overflow:hidden}
  .train-block{position:absolute;top:2px;bottom:2px;border-radius:2px;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-size:.6rem;letter-spacing:1px;white-space:nowrap;overflow:hidden;padding:0 6px;cursor:pointer;transition:filter .2s}
  .train-block:hover{filter:brightness(1.3)}

  /* Toolbar above table */
  .table-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
  .table-toolbar-left{display:flex;gap:10px;align-items:center}

  .trains-table{width:100%;border-collapse:collapse;font-size:.82rem}
  .trains-table th{font-family:var(--font-mono);font-size:.65rem;letter-spacing:2px;color:var(--ocean-deep);text-align:left;padding:10px 12px;border-bottom:2px solid var(--accent2);background:#f5f9fc;opacity:.8}
  .trains-table td{padding:12px;border-bottom:1px solid #e8f0f5;vertical-align:middle;color:var(--text)}
  .trains-table tr:hover td{background:#f0f7fc}

  .badge{display:inline-block;font-family:var(--font-mono);font-size:.65rem;letter-spacing:1px;padding:3px 8px;border-radius:3px;font-weight:600}
  .badge-orge{background:rgba(212,168,67,.18);color:#8a6010;border:1px solid rgba(212,168,67,.4)}
  .badge-ble{background:rgba(0,153,204,.12);color:#005f8e;border:1px solid rgba(0,153,204,.3)}
  .badge-mais{background:rgba(0,184,156,.12);color:#006d5b;border:1px solid rgba(0,184,156,.3)}
  .badge-colza{background:rgba(224,90,30,.12);color:#b03000;border:1px solid rgba(224,90,30,.3)}
  .badge-tournesol{background:rgba(255,180,0,.15);color:#8a6000;border:1px solid rgba(255,180,0,.35)}

  .status-dot{width:9px;height:9px;border-radius:50%;display:inline-block;margin-right:6px}
  .status-en-route{background:#0099cc;box-shadow:0 0 6px rgba(0,153,204,0.5)}
  .status-planifie{background:#d4a843}
  .status-arrive{background:#6a8a9a}
  .status-alerte{background:#e05a1e;animation:pulse 1s infinite;box-shadow:0 0 6px rgba(224,90,30,0.5)}
  .status-quai{background:#f0b030;box-shadow:0 0 6px rgba(240,176,48,0.6);animation:pulse 1.5s infinite}
  .status-dechargement{background:#00d4aa;box-shadow:0 0 6px rgba(0,212,170,0.6);animation:pulse 1.2s infinite}
  .alert-item.acked{opacity:.7}
  .alert-item.acked .alert-icon{filter:grayscale(.5)}
  .trains-table tr[onclick]{transition:background .15s}

  .progress-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;width:80px}
  .progress-fill{height:100%;border-radius:2px}

  .alerts-list{display:flex;flex-direction:column;gap:10px}
  .alert-item{background:white;border:1px solid var(--border);border-radius:6px;padding:14px 16px;display:flex;gap:14px;align-items:flex-start;box-shadow:0 1px 6px rgba(0,95,142,0.07)}
  .alert-item.critical{border-left:3px solid var(--accent3)}
  .alert-item.warning{border-left:3px solid var(--accent)}
  .alert-item.info{border-left:3px solid var(--accent2)}
  .alert-icon{font-size:1.2rem}.alert-text{flex:1}
  .alert-title{font-weight:600;font-size:.85rem}
  .alert-desc{font-size:.78rem;color:var(--text-dim);margin-top:3px}
  .alert-time{font-family:var(--font-mono);font-size:.7rem;color:var(--text-dim)}

  .tonnage-bar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .tbar-label{width:100px;font-size:.78rem;color:var(--text-dim)}
  .tbar-track{flex:1;height:10px;background:var(--border);border-radius:2px;overflow:hidden}
  .tbar-fill{height:100%;border-radius:2px;transition:width 1s ease}
  .tbar-val{font-family:var(--font-mono);font-size:.75rem;width:60px;text-align:right}

  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,61,92,.6);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center}
  .modal-overlay.open{display:flex}
  .modal{background:white;border:1px solid var(--border);border-radius:10px;padding:28px;width:480px;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,61,92,0.25)}
  .modal-title{font-family:var(--font-display);font-size:1.5rem;letter-spacing:3px;color:var(--ocean-deep);margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid var(--accent2)}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

  .toast{position:fixed;bottom:60px;right:20px;background:white;border:1px solid var(--border);border-radius:6px;padding:12px 18px;font-family:var(--font-mono);font-size:.8rem;z-index:500;transform:translateY(80px);opacity:0;transition:all .3s;box-shadow:0 4px 20px rgba(0,95,142,0.2);color:var(--text)}
  .toast.show{transform:none;opacity:1}
  .toast.success{border-left:3px solid var(--accent2);color:var(--ocean-deep)}
  .toast.error{border-left:3px solid var(--accent3);color:var(--accent3)}

  ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#e8f0f5}::-webkit-scrollbar-thumb{background:var(--accent2);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--accent)}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  .tab-content.active>*{animation:fadeIn .3s ease forwards}

  .ticker{background:linear-gradient(90deg,var(--ocean-deep),var(--ocean-mid));border-top:3px solid var(--wheat);padding:6px 0;overflow:hidden;white-space:nowrap;position:fixed;bottom:0;left:0;right:0;font-family:var(--font-mono);font-size:.72rem;color:rgba(255,255,255,0.9);z-index:50}
  .ticker-inner{display:inline-block;animation:scroll 40s linear infinite}
  @keyframes scroll{from{transform:translateX(100vw)}to{transform:translateX(-100%)}}

  /* ‚îÄ‚îÄ Page D√©tail Convoi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .detail-overlay{
    display:none;position:fixed;inset:0;z-index:150;
    background:var(--bg);overflow-y:auto;padding-bottom:40px;
  }
  .detail-overlay.open{display:block;animation:fadeIn .25s ease}
  .detail-header{
    background:linear-gradient(135deg,var(--ocean-deep) 0%,var(--ocean-mid) 100%);
    padding:16px 32px;display:flex;align-items:center;justify-content:space-between;
    border-bottom:3px solid var(--wheat);position:sticky;top:0;z-index:10;
  }
  .detail-header-left{display:flex;align-items:center;gap:16px}
  .detail-back{
    background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);
    color:white;padding:8px 16px;border-radius:3px;cursor:pointer;
    font-family:var(--font-mono);font-size:.8rem;letter-spacing:1px;transition:all .2s;
  }
  .detail-back:hover{background:rgba(255,255,255,.3)}
  .detail-train-id{font-family:var(--font-display);font-size:2rem;letter-spacing:4px;color:white}
  .detail-subtitle{font-family:var(--font-mono);font-size:.8rem;color:rgba(255,255,255,.6);margin-top:2px}
  .detail-status-badge{
    font-family:var(--font-mono);font-size:.8rem;letter-spacing:2px;
    padding:6px 16px;border-radius:20px;font-weight:600;
  }
  .detail-body{padding:32px;max-width:1200px;margin:0 auto}

  /* Info cards */
  .detail-info-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}
  .detail-info-card{
    background:var(--panel);border:1px solid var(--border);border-radius:8px;
    padding:18px 20px;box-shadow:0 2px 10px rgba(0,95,142,.07);
  }
  .detail-info-label{font-family:var(--font-mono);font-size:.62rem;letter-spacing:2px;color:var(--text-dim);margin-bottom:6px;text-transform:uppercase}
  .detail-info-value{font-size:1.1rem;font-weight:600;color:var(--text)}
  .detail-info-sub{font-size:.75rem;color:var(--text-dim);margin-top:3px}

  /* Train visuel */
  .train-visual-section{
    background:var(--panel);border:1px solid var(--border);border-radius:8px;
    padding:28px;margin-bottom:24px;box-shadow:0 2px 10px rgba(0,95,142,.07);
    overflow:hidden;
  }
  .train-visual-title{font-family:var(--font-mono);font-size:.7rem;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:20px;padding-bottom:8px;border-bottom:2px solid var(--accent2)}
  .train-scene{
    background:linear-gradient(180deg, transparent 60%, rgba(0,95,142,.06) 100%);
    border-radius:6px;padding:20px 16px 8px;position:relative;overflow-x:auto;
  }
  .train-svg-container{display:flex;align-items:flex-end;gap:3px;min-width:max-content;padding-bottom:12px}

  /* Wagons SVG inline */
  .wagon-loco svg, .wagon-car svg{display:block}
  .wagon-loco{filter:drop-shadow(0 4px 8px rgba(0,0,0,.3))}
  .wagon-car{filter:drop-shadow(0 3px 6px rgba(0,0,0,.2));transition:transform .2s}
  .wagon-car:hover{transform:translateY(-4px)}
  .wagon-car.unloaded{opacity:.35;filter:grayscale(.8)}

  /* Rails */
  .train-rails{height:8px;background:repeating-linear-gradient(90deg,var(--border) 0,var(--border) 20px,transparent 20px,transparent 30px);border-radius:2px;margin:0 16px;position:relative}
  .train-rails::before,.train-rails::after{content:'';position:absolute;top:2px;left:0;right:0;height:2px;background:var(--border);border-radius:1px}
  .train-rails::after{top:4px}

  /* Progress d√©chargement */
  .unload-section{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 2px 10px rgba(0,95,142,.07)}
  .unload-title{font-family:var(--font-mono);font-size:.7rem;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:20px;padding-bottom:8px;border-bottom:2px solid var(--accent2)}
  .unload-progress-wrap{margin-bottom:20px}
  .unload-labels{display:flex;justify-content:space-between;margin-bottom:8px}
  .unload-pct{font-family:var(--font-display);font-size:3rem;line-height:1;color:var(--ocean-deep)}
  body.dark .unload-pct{color:#7dd3f0}
  .unload-tons{font-family:var(--font-mono);font-size:.85rem;color:var(--text-dim);text-align:right;padding-top:8px}
  .unload-bar-track{height:24px;background:var(--border);border-radius:12px;overflow:hidden;position:relative}
  .unload-bar-fill{
    height:100%;border-radius:12px;
    background:linear-gradient(90deg,var(--accent2),var(--ocean-mid));
    transition:width 1.5s cubic-bezier(.4,0,.2,1);
    position:relative;overflow:hidden;
  }
  .unload-bar-fill::after{
    content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);
    animation:shimmer 2s infinite;
  }
  @keyframes shimmer{to{left:200%}}
  .unload-steps{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:20px}
  .unload-step{
    background:var(--bg);border:1px solid var(--border);border-radius:6px;
    padding:12px;text-align:center;transition:all .3s;
  }
  .unload-step.done{background:rgba(0,153,204,.1);border-color:var(--accent2)}
  .unload-step.active{background:rgba(0,153,204,.15);border-color:var(--accent2);box-shadow:0 0 12px rgba(0,153,204,.2)}
  .unload-step-icon{font-size:1.4rem;margin-bottom:4px}
  .unload-step-label{font-family:var(--font-mono);font-size:.6rem;letter-spacing:1px;color:var(--text-dim);text-transform:uppercase}
  .unload-step.done .unload-step-label,.unload-step.active .unload-step-label{color:var(--accent2)}

  /* Controls d√©chargement */
  .unload-controls{display:flex;align-items:center;gap:12px;margin-top:16px;flex-wrap:wrap}
  .unload-input-group{display:flex;align-items:center;gap:8px;font-family:var(--font-mono);font-size:.8rem;color:var(--text-dim)}
  .unload-input{width:80px;text-align:center;font-family:var(--font-mono);padding:6px 8px;border:1px solid var(--border);border-radius:3px;background:var(--bg);color:var(--text)}

  /* Timeline d√©tail */
  .detail-timeline{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:24px;box-shadow:0 2px 10px rgba(0,95,142,.07)}
  .journey-bar{position:relative;height:40px;background:var(--bg);border-radius:6px;overflow:hidden;margin:16px 0}
  .journey-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding-left:12px;font-family:var(--font-mono);font-size:.75rem;color:white;font-weight:600;transition:width 1s ease}
  .journey-marker{position:absolute;top:-6px;height:52px;width:2px;background:var(--accent3);z-index:5}
  .journey-marker::after{content:'‚ñº MAINTENANT';position:absolute;top:-18px;left:4px;font-family:var(--font-mono);font-size:.55rem;color:var(--accent3);white-space:nowrap}
  .journey-times{display:flex;justify-content:space-between;font-family:var(--font-mono);font-size:.7rem;color:var(--text-dim);margin-top:4px}

  /* ‚îÄ‚îÄ Toggle Dark Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .theme-toggle{
    display:flex;align-items:center;gap:8px;cursor:pointer;
    background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.25);
    border-radius:20px;padding:5px 12px 5px 8px;
    font-family:var(--font-mono);font-size:.7rem;color:white;
    transition:all .2s;user-select:none;
  }
  .theme-toggle:hover{background:rgba(255,255,255,0.22)}
  .toggle-track{
    width:32px;height:18px;background:rgba(255,255,255,0.2);
    border-radius:9px;position:relative;transition:background .3s;
    border:1px solid rgba(255,255,255,0.3);flex-shrink:0;
  }
  .toggle-thumb{
    position:absolute;top:2px;left:2px;
    width:12px;height:12px;border-radius:50%;
    background:white;transition:transform .3s,background .3s;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }
  body.dark .toggle-track{background:rgba(0,153,204,0.5);border-color:var(--accent2)}
  body.dark .toggle-thumb{transform:translateX(14px);background:var(--accent2)}

  /* ‚îÄ‚îÄ Dark Mode Variables ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  body.dark{
    --bg:#0a0e14;
    --panel:#0f1520;
    --border:#1a2535;
    --text:#c8d8e8;
    --text-dim:#4a6070;
    --ocean-light:#0d1520;
    background-image:linear-gradient(180deg,#0d1825 0%,#0a0e14 100%) !important;
  }
  body.dark::after{
    background:
      radial-gradient(ellipse at 0% 100%, rgba(0,100,160,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 100% 0%, rgba(0,153,204,0.06) 0%, transparent 60%) !important;
  }
  body.dark .sidebar{
    background:linear-gradient(180deg,#0f1520 0%,#0d1218 100%) !important;
    border-right-color:#1a2535 !important;
    box-shadow:2px 0 10px rgba(0,0,0,0.3) !important;
  }
  body.dark .tabs{background:#0f1520 !important;border-bottom-color:#1a2535 !important;box-shadow:0 2px 8px rgba(0,0,0,0.3) !important;}
  body.dark .tab{color:#4a6070 !important}
  body.dark .tab.active{color:#7dd3f0 !important}
  body.dark .tab-content{background:#0a0e14 !important}
  body.dark .stat-card{background:#0f1520 !important;border-color:#1a2535 !important;box-shadow:0 2px 12px rgba(0,0,0,0.3) !important}
  body.dark .stat-value{color:#7dd3f0 !important}
  body.dark .rail-visual{background:#0f1520 !important;border-color:#1a2535 !important;box-shadow:none !important}
  body.dark .track-bar{background:#0d1520 !important;border-color:#1a2535 !important}
  body.dark .trains-table th{background:#0d1520 !important;color:#4a8aaa !important;border-bottom-color:#0077aa !important;opacity:1 !important}
  body.dark .trains-table td{border-bottom-color:#1a2535 !important;color:#c8d8e8 !important}
  body.dark .trains-table tr:hover td{background:#0f1a25 !important}
  body.dark input,body.dark select,body.dark textarea{background:#0d1520 !important;border-color:#1a2535 !important;color:#c8d8e8 !important;box-shadow:none !important}
  body.dark select option{background:#0f1520 !important;color:#c8d8e8 !important}
  body.dark .alert-box{background:rgba(0,100,160,.12) !important;border-color:rgba(0,153,204,.2) !important}
  body.dark .alert-item{background:#0f1520 !important;border-color:#1a2535 !important;box-shadow:none !important}
  body.dark .modal{background:#0f1520 !important;border-color:#1a2535 !important}
  body.dark .modal-title{color:#7dd3f0 !important}
  body.dark .toast{background:#0f1520 !important;border-color:#1a2535 !important;color:#c8d8e8 !important}
  body.dark .section-title{color:#4a8aaa !important}
  body.dark label{color:#4a8aaa !important}
  body.dark .tbar-label{color:#4a6070 !important}
  body.dark .progress-bar{background:#1a2535 !important}
  body.dark ::-webkit-scrollbar-track{background:#0d1520 !important}
  body.dark .table-toolbar span{color:#4a6070 !important}
  /* Transition douce sur tout */
  body,body *{transition:background-color .3s,border-color .3s,color .2s,box-shadow .3s}
  /* Sauf les animations */
  .ticker-inner,.train-block,.progress-fill,.tbar-fill,.toggle-thumb,.toggle-track{transition:none !important}
  .toggle-thumb{transition:transform .3s,background .3s !important}
  .toggle-track{transition:background .3s !important}
</style>
</head>
<body>

<header>
  <div class="logo-area">
    <img class="logo-img" src="https://www.sica-atlantique.com/wp-content/uploads/2020/07/logo-gsa-185x56-1.png" alt="SICA Atlantique" onerror="this.style.display='none'">
    <div class="logo-divider"></div>
    <div class="logo">RAILPLAN <span>// GESTION FERROVIAIRE</span></div>
  </div>
  <div class="clock" id="clock">--:--:--</div>
  <div class="header-actions">
    <div class="theme-toggle" onclick="toggleDark()" id="themeToggle">
      <div class="toggle-track"><div class="toggle-thumb"></div></div>
      <span id="themeLabel">NUIT</span>
    </div>
    <button class="btn btn-csv" onclick="exportCSV()">‚¨á EXPORT CSV</button>
    <button class="btn btn-success" onclick="openModal()">+ NOUVEAU CONVOI</button>
    <button class="btn btn-primary" onclick="toggleTV()">üì∫ MODE TV</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div>
      <div class="section-title">‚ö° ALERTING EMAIL</div>
      <div class="alert-box">
        <div class="alert-status" style="margin-bottom:10px">
          <span class="dot"></span>
          <span style="font-size:.8rem">Alertes actives</span>
        </div>
        <div class="form-group">
          <label>EMAIL DESTINATAIRE</label>
          <input type="email" id="alertEmail" placeholder="email@exemple.com">
        </div>
        <div class="form-group">
          <label>D√âLAI ALERTE (min avant arriv√©e)</label>
          <input type="number" id="alertDelay" value="60" min="15" max="480">
        </div>
        <div class="form-group">
          <label>TYPE D'ALERTES</label>
          <select id="alertTypes">
            <option value="all">Toutes les alertes</option>
            <option value="arrival">Arriv√©e imminente</option>
            <option value="delay">Retards uniquement</option>
            <option value="critical">Critiques seulement</option>
          </select>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-danger" style="flex:1" onclick="saveAlertConfig()">SAUVEGARDER</button>
          <button class="btn btn-primary" style="flex:1" onclick="testAlert()">TEST EMAIL</button>
        </div>
      </div>
    </div>

    <div>
      <div class="section-title">üîç FILTRES</div>
      <div class="form-group">
        <label>LIGNE</label>
        <select id="filterRail" onchange="loadTrains()">
          <option value="all">Toutes les lignes</option>
          <option value="1">Ligne A ‚Äî Nord</option>
          <option value="2">Ligne B ‚Äî Est</option>
          <option value="3">Ligne C ‚Äî Ouest</option>
        </select>
      </div>
      <div class="form-group">
        <label>MARCHANDISE</label>
        <select id="filterCargo" onchange="loadTrains()">
          <option value="all">Toutes</option>
          <option value="Orge">Orge</option>
          <option value="Bl√©">Bl√©</option>
          <option value="Ma√Øs">Ma√Øs</option>
          <option value="Colza">Colza</option>
          <option value="Tournesol">Tournesol</option>
        </select>
      </div>
      <div class="form-group">
        <label>STATUT</label>
        <select id="filterStatus" onchange="loadTrains()">
          <option value="all">Tous</option>
          <option value="En route">En route</option>
          <option value="Planifi√©">Planifi√©</option>
          <option value="Mise √† quai">Mise √† quai</option>
          <option value="En d√©chargement">En d√©chargement</option>
          <option value="Arriv√©">Arriv√©</option>
          <option value="Alerte">Alerte</option>
        </select>
      </div>
    </div>

    <div>
      <div class="section-title">‚öñÔ∏è TONNAGE PAR MARCHANDISE</div>
      <div id="tonnageSummary"></div>
    </div>
  </aside>

  <main class="main">
    <div class="tabs">
      <div class="tab active" data-tab="overview" onclick="switchTab(this)">VUE G√âN√âRALE</div>
      <div class="tab" data-tab="trains" onclick="switchTab(this)">CONVOIS</div>
      <div class="tab" data-tab="timeline" onclick="switchTab(this)">TIMELINE</div>
      <div class="tab" data-tab="alerts" onclick="switchTab(this)">ALERTES</div>
    </div>

    <div class="tab-content active" id="tab-overview">
      <div class="stats-row" id="statsRow"></div>
      <div class="rail-visual">
        <div class="section-title">PLANNING DES VOIES ‚Äî AUJOURD'HUI</div>
        <div id="railTimeline"></div>
      </div>
      <div class="rail-visual">
        <div class="section-title">R√âPARTITION MARCHANDISES</div>
        <div id="cargoChart"></div>
      </div>
    </div>

    <div class="tab-content" id="tab-trains">
      <div class="table-toolbar">
        <div class="table-toolbar-left">
          <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--text-dim)" id="trainCount">‚Äî convois</span>
        </div>
        <button class="btn btn-csv" onclick="exportCSV()">‚¨á EXPORT CSV (FILTR√â)</button>
      </div>
      <table class="trains-table">
        <thead>
          <tr>
            <th>ID CONVOI</th><th>LIGNE</th><th>MARCHANDISE</th><th>TONNAGE</th>
            <th>CLIENT</th><th>D√âPART</th><th>ARRIV√âE</th><th>STATUT</th>
            <th>PROGRESS</th><th>ACTIONS</th>
          </tr>
        </thead>
        <tbody id="trainsBody"></tbody>
      </table>
    </div>

    <div class="tab-content" id="tab-timeline">
      <div class="rail-visual" id="fullTimeline"></div>
    </div>

    <div class="tab-content" id="tab-alerts">
      <div id="alertsList"></div>
    </div>
  </main>
</div>

<!-- Page D√©tail Convoi -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-header">
    <div class="detail-header-left">
      <button class="detail-back" onclick="closeDetail()">‚Üê RETOUR</button>
      <div>
        <div class="detail-train-id" id="detailId">‚Äî</div>
        <div class="detail-subtitle" id="detailSubtitle">‚Äî</div>
      </div>
    </div>
    <div id="detailStatusBadge" class="detail-status-badge"></div>
  </div>

  <div class="detail-body">
    <!-- Info cards -->
    <div class="detail-info-grid" id="detailInfoGrid"></div>

    <!-- Train visuel -->
    <div class="train-visual-section">
      <div class="train-visual-title">üöÇ COMPOSITION DU CONVOI</div>
      <div class="train-scene">
        <div class="train-svg-container" id="trainSvgContainer"></div>
        <div class="train-rails" id="trainRails"></div>
      </div>
      <div style="margin-top:12px;font-family:var(--font-mono);font-size:.7rem;color:var(--text-dim);text-align:center" id="wagonLegend"></div>
    </div>

    <!-- D√©chargement -->
    <div class="unload-section">
      <div class="unload-title">‚öôÔ∏è PROGRESSION ‚Äî MISE √Ä QUAI & D√âCHARGEMENT</div>
      <div class="unload-progress-wrap">
        <div class="unload-labels">
          <div class="unload-pct" id="unloadPct">0%</div>
          <div class="unload-tons" id="unloadTons"></div>
        </div>
        <div class="unload-bar-track">
          <div class="unload-bar-fill" id="unloadBar" style="width:0%"></div>
        </div>
      </div>
      <div class="unload-steps" id="unloadSteps"></div>
      <div class="unload-controls">
        <div class="unload-input-group">
          <span>Tonnes d√©charg√©es :</span>
          <input type="number" class="unload-input" id="unloadInput" min="0" placeholder="0">
          <span id="unloadMax">/ 0t</span>
        </div>
        <button class="btn btn-success" onclick="saveUnload()">‚úì METTRE √Ä JOUR</button>
        <button class="btn" style="border-color:#f0b030;color:#f0b030" id="btnQuaiDetail" onclick="setQuaiFromDetail()">üõ§Ô∏è MISE √Ä QUAI</button>
        <button class="btn btn-danger" onclick="resetUnload()">‚Ü∫ RESET</button>
      </div>
    </div>

    <!-- Dates voyage (r√©sum√© compact) -->
    <div class="detail-timeline">
      <div class="unload-title">üìÖ INFORMATIONS DU VOYAGE</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div style="font-family:var(--font-mono);font-size:.85rem">
          <span style="color:var(--text-dim);font-size:.65rem;letter-spacing:2px;display:block;margin-bottom:4px">D√âPART</span>
          <span id="journeyDepart" style="color:var(--text)">‚Äî</span>
        </div>
        <div style="flex:1;height:2px;background:var(--border);margin:0 20px;position:relative">
          <div id="journeyProgressLine" style="position:absolute;top:0;left:0;height:2px;background:var(--accent2);transition:width 1s ease"></div>
          <div id="journeyDot" style="position:absolute;top:-4px;width:10px;height:10px;border-radius:50%;background:var(--accent3);transform:translateX(-50%);display:none"></div>
        </div>
        <div style="font-family:var(--font-mono);font-size:.85rem;text-align:right">
          <span style="color:var(--text-dim);font-size:.65rem;letter-spacing:2px;display:block;margin-bottom:4px">ARRIV√âE PR√âVUE</span>
          <span id="journeyArrivee" style="color:var(--text)">‚Äî</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="ticker"><span class="ticker-inner" id="tickerText">Chargement...</span></div>
<div class="toast" id="toast"></div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-title">NOUVEAU CONVOI</div>
    <div style="font-family:var(--font-mono);font-size:.68rem;color:var(--accent2);background:rgba(0,153,204,.08);border:1px solid rgba(0,153,204,.2);border-radius:4px;padding:8px 12px;margin-bottom:16px">
      üîí L'identifiant TRN-XXX sera g√©n√©r√© automatiquement et unique
    </div>
    <div class="form-group"><label>LIGNE DE RAIL</label>
      <select id="formRail">
        <option value="1">Ligne A ‚Äî Nord</option>
        <option value="2">Ligne B ‚Äî Est</option>
        <option value="3">Ligne C ‚Äî Ouest</option>
      </select>
    </div>
    <div class="form-group"><label>MARCHANDISE</label>
      <select id="formCargo">
        <option>Orge</option><option>Bl√©</option><option>Ma√Øs</option><option>Colza</option><option>Tournesol</option>
      </select>
    </div>
    <div class="form-group"><label>TONNAGE (t)</label>
      <input type="number" id="formTonnage" value="1200" min="100" max="9999">
    </div>
    <div class="form-group"><label>CLIENT / DESTINATAIRE</label>
      <input type="text" id="formClient" placeholder="Nom du client">
    </div>
    <div class="form-group"><label>DATE & HEURE DE D√âPART</label>
      <input type="datetime-local" id="formDepart">
    </div>
    <div class="form-group"><label>DATE & HEURE D'ARRIV√âE</label>
      <input type="datetime-local" id="formArrivee">
    </div>
    <div class="form-group"><label>NOTES</label>
      <textarea id="formNotes" rows="2" style="resize:vertical" placeholder="Notes..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="closeModal()">ANNULER</button>
      <button class="btn btn-success" onclick="addTrain()">CR√âER CONVOI</button>
    </div>
  </div>
</div>

<script>
const RAILS={1:{name:'Ligne A ‚Äî Nord',color:'#f5a623'},2:{name:'Ligne B ‚Äî Est',color:'#00d4aa'},3:{name:'Ligne C ‚Äî Ouest',color:'#a78bfa'}};
const CARGO_COLORS={Orge:'#f5a623',Bl√©:'#00d4aa',Ma√Øs:'#a78bfa',Colza:'#e84545',Tournesol:'#ffc800'};
let trainsData=[];

// Clock
setInterval(()=>{
  const n=new Date();
  document.getElementById('clock').textContent=
    n.toLocaleDateString('fr-FR')+' '+n.toLocaleTimeString('fr-FR');
},1000);

// Toast
function toast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+type+' show';
  setTimeout(()=>t.className='toast',3000);
}

// Helpers
function fmtDate(s){if(!s)return'‚Äî';const d=new Date(s);return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}
function getProgress(t){const n=new Date(),dep=new Date(t.depart),arr=new Date(t.arrivee);if(n<dep)return 0;if(n>arr)return 100;return Math.round((n-dep)/(arr-dep)*100)}
function cargoClass(c){return'badge badge-'+({Orge:'orge',Bl√©:'ble',Ma√Øs:'mais',Colza:'colza',Tournesol:'tournesol'}[c]||'orge')}
function statusHTML(s){return`<span class="status-dot status-${({'En route':'en-route',Planifi√©:'planifie',Arriv√©:'arrive',Alerte:'alerte','Mise √† quai':'quai','En d√©chargement':'dechargement'}[s]||'planifie')}"></span>${s}`}
function getFilters(){return{rail:document.getElementById('filterRail').value,cargo:document.getElementById('filterCargo').value,status:document.getElementById('filterStatus').value}}

// API
async function api(url,opts={}){
  const r=await fetch(url,{headers:{'Content-Type':'application/json'},...opts});
  return r.json();
}

// Load trains
async function loadTrains(){
  const{rail,cargo,status}=getFilters();
  const params=new URLSearchParams();
  if(rail!=='all')params.set('rail',rail);
  if(cargo!=='all')params.set('cargo',cargo);
  if(status!=='all')params.set('status',status);
  trainsData=await api('/api/trains?'+params);
  renderAll();
}

// Export CSV
function exportCSV(){
  const{rail,cargo,status}=getFilters();
  const params=new URLSearchParams();
  if(rail!=='all')params.set('rail',rail);
  if(cargo!=='all')params.set('cargo',cargo);
  if(status!=='all')params.set('status',status);
  window.location.href='/api/export/csv?'+params;
  toast('üì• Export CSV t√©l√©charg√© !');
}

// Stats
async function renderStats(){
  const s=await api('/api/stats');
  document.getElementById('statsRow').innerHTML=`
    <div class="stat-card s1"><div class="stat-label">EN ROUTE</div><div class="stat-value" style="color:var(--rail2)">${s.en_route}</div><div class="stat-sub">convois actifs</div></div>
    <div class="stat-card s2"><div class="stat-label">PLANIFI√âS</div><div class="stat-value" style="color:var(--rail1)">${s.planifie}</div><div class="stat-sub">convois pr√©vus</div></div>
    <div class="stat-card s3"><div class="stat-label">TONNAGE TOTAL</div><div class="stat-value" style="color:var(--rail3)">${(s.tonnage_total/1000).toFixed(1)}k</div><div class="stat-sub">tonnes</div></div>
    <div class="stat-card s4"><div class="stat-label">ALERTES</div><div class="stat-value" style="color:var(--accent3)">${s.alerte}</div><div class="stat-sub">n√©cessitent attention</div></div>`;
}

// Rail Timeline
function renderRailTimeline(){
  const now=new Date(),dayStart=new Date(now);dayStart.setHours(0,0,0,0);
  const dayEnd=new Date(now);dayEnd.setHours(24,0,0,0);
  const span=dayEnd-dayStart;
  let html='';
  [1,2,3].forEach(r=>{
    const rail=RAILS[r];
    const rt=trainsData.filter(t=>t.rail===r);
    let blocks=rt.map(t=>{
      const dep=new Date(t.depart),arr=new Date(t.arrivee);
      const left=Math.max(0,(dep-dayStart)/span*100);
      const width=Math.max(1,(arr-dep)/span*100);
      const unloadPct_ = Math.min(100, Math.round(getUnloaded(t.id)/t.tonnage*100));
      const blockW = Math.min(width,100-left);
      return`<div class="train-block" style="left:${left}%;width:${blockW}%;background:${rail.color};opacity:${t.status==='Arriv√©'?.4:1};color:#000;cursor:pointer;justify-content:space-between;padding:0 6px" title="Cliquer pour voir le d√©tail" onclick="openDetail(${t.id})">
        <span style="font-weight:700;font-size:.62rem">${t.train_id}</span>
        ${blockW>8?`<span style="font-size:.6rem;opacity:.85">${unloadPct_>0?'‚¨á'+unloadPct_+'%':t.cargo}</span>`:''}
      </div>`;
    }).join('');
    const nowPct=Math.max(0,Math.min(100,(now-dayStart)/span*100));
    html+=`<div class="rail-track"><div class="rail-name" style="color:${rail.color}"><span class="rail-indicator" style="background:${rail.color}"></span>${rail.name.split('‚Äî')[0]}</div><div class="track-bar">${blocks}<div style="position:absolute;left:${nowPct}%;top:0;bottom:0;width:2px;background:rgba(255,255,255,.3);z-index:10"></div></div></div>`;
  });
  html+=`<div style="display:flex;margin-left:92px;font-family:var(--font-mono);font-size:.6rem;color:var(--text-dim);margin-top:4px">${Array.from({length:7},(_,i)=>`<div style="flex:1">${String(i*4).padStart(2,'0')}:00</div>`).join('')}</div>`;
  document.getElementById('railTimeline').innerHTML=html;
}

// Cargo chart
function renderCargoChart(){
  const totals={};
  trainsData.forEach(t=>{totals[t.cargo]=(totals[t.cargo]||0)+t.tonnage});
  const max=Math.max(...Object.values(totals),1);
  document.getElementById('cargoChart').innerHTML=Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`
    <div class="tonnage-bar"><div class="tbar-label">${c}</div><div class="tbar-track"><div class="tbar-fill" style="width:${Math.round(v/max*100)}%;background:${CARGO_COLORS[c]||'#888'}"></div></div><div class="tbar-val" style="color:${CARGO_COLORS[c]||'#888'}">${v.toLocaleString()}t</div></div>`).join('')||'<p style="color:var(--text-dim);font-size:.8rem">Aucune donn√©e</p>';
}

// Tonnage sidebar
function renderTonnage(){
  const totals={};
  trainsData.forEach(t=>{totals[t.cargo]=(totals[t.cargo]||0)+t.tonnage});
  const max=Math.max(...Object.values(totals),1);
  document.getElementById('tonnageSummary').innerHTML=Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([c,v])=>`
    <div class="tonnage-bar"><div class="tbar-label" style="font-size:.75rem">${c}</div><div class="tbar-track"><div class="tbar-fill" style="width:${Math.round(v/max*100)}%;background:${CARGO_COLORS[c]||'#888'}"></div></div><div class="tbar-val" style="color:${CARGO_COLORS[c]||'#888'};font-size:.7rem">${v.toLocaleString()}t</div></div>`).join('')||'<p style="color:var(--text-dim);font-size:.75rem">Aucun convoi</p>';
}

// Trains table
function renderTrains(){
  document.getElementById('trainCount').textContent=`${trainsData.length} convoi${trainsData.length>1?'s':''}`;
  document.getElementById('trainsBody').innerHTML=trainsData.map(t=>{
    const prog=getProgress(t);
    const rc=RAILS[t.rail]?.color||'#888';
    const canQuai = t.status==='En route'||t.status==='Planifi√©'||t.status==='Alerte';
    const isQuai  = t.status==='Mise √† quai';
    return`<tr style="cursor:pointer" onclick="openDetail(${t.id})">
      <td><span style="font-family:var(--font-mono);color:${rc}">${t.train_id}</span></td>
      <td><span class="rail-indicator" style="background:${rc}"></span>${RAILS[t.rail]?.name.split('‚Äî')[0]||''}</td>
      <td><span class="${cargoClass(t.cargo)}">${t.cargo}</span></td>
      <td><b style="font-family:var(--font-mono)">${t.tonnage.toLocaleString()}</b> <span style="color:var(--text-dim);font-size:.75rem">t</span></td>
      <td style="font-size:.8rem;color:var(--text-dim)">${t.client}</td>
      <td style="font-family:var(--font-mono);font-size:.78rem">${fmtDate(t.depart)}</td>
      <td style="font-family:var(--font-mono);font-size:.78rem">${fmtDate(t.arrivee)}</td>
      <td>${statusHTML(t.status)}</td>
      <td><div class="progress-bar"><div class="progress-fill" style="width:${prog}%;background:${rc}"></div></div><div style="font-family:var(--font-mono);font-size:.65rem;color:var(--text-dim);margin-top:2px">${prog}%</div></td>
      <td onclick="event.stopPropagation()" style="white-space:nowrap;display:flex;gap:4px;align-items:center;padding:8px 12px">
        <button class="btn" style="font-size:.6rem;padding:4px 8px;border-color:var(--accent2);color:var(--accent2)" onclick="openDetail(${t.id})">üîç</button>
        ${canQuai?`<button class="btn" style="font-size:.6rem;padding:4px 6px;border-color:#f0b030;color:#f0b030" title="Mettre √† quai" onclick="setQuai(${t.id})">üõ§Ô∏è</button>`:''}
        ${isQuai?`<span style="font-family:var(--font-mono);font-size:.6rem;color:#f0b030">√Ä QUAI</span>`:''}
        <button class="btn btn-danger" style="font-size:.6rem;padding:4px 8px" onclick="deleteTrain(${t.id})">‚úï</button>
      </td>
    </tr>`;
  }).join('')||'<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-dim)">Aucun convoi trouv√©</td></tr>';
}

// Full timeline
function renderFullTimeline(){
  const now=new Date(),refStart=new Date(now);refStart.setHours(0,0,0,0);
  const refEnd=new Date(refStart);refEnd.setHours(48,0,0,0);
  const span=refEnd-refStart;
  let html=`<div class="section-title">PLANNING D√âTAILL√â ‚Äî 48H</div>`;
  html+=`<div style="margin-left:180px;display:flex;font-family:var(--font-mono);font-size:.6rem;color:var(--text-dim);margin-bottom:8px">${Array.from({length:9},(_,i)=>{const d=new Date(refStart);d.setHours(i*6);return`<div style="flex:1">${d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})} ${String(i*6%24).padStart(2,'0')}h</div>`}).join('')}</div>`;
  trainsData.forEach(t=>{
    const dep=new Date(t.depart),arr=new Date(t.arrivee),rc=RAILS[t.rail]?.color||'#888';
    const left=Math.max(0,(dep-refStart)/span*100),width=Math.max(.5,(arr-dep)/span*100);
    html+=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;cursor:pointer" onclick="openDetail(${t.id})" title="Cliquer pour le d√©tail">
      <div style="width:168px;flex-shrink:0;font-size:.78rem"><span style="font-family:var(--font-mono);color:${rc}">${t.train_id}</span><br><span style="color:var(--text-dim);font-size:.7rem">${t.client}</span></div>
      <div style="flex:1;height:32px;background:var(--border);border:1px solid var(--border);border-radius:4px;position:relative;overflow:hidden;transition:filter .2s" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter=''">
        <div style="position:absolute;left:${left}%;width:${Math.min(width,100-left)}%;top:2px;bottom:2px;background:${rc};border-radius:2px;display:flex;align-items:center;padding:0 6px;font-family:var(--font-mono);font-size:.62rem;color:#000;white-space:nowrap;overflow:hidden">${t.cargo} ¬∑ ${t.tonnage}t</div>
      </div></div>`;
  });
  document.getElementById('fullTimeline').innerHTML=html||'<p style="color:var(--text-dim)">Aucun convoi</p>';
}

// Alerts ‚Äî avec acquittement
function getAckKey(id){ return 'railplan-ack-'+id; }
function getAck(id){ try{return JSON.parse(localStorage.getItem(getAckKey(id)))||null;}catch{return null;} }
function setAck(id,comment){ localStorage.setItem(getAckKey(id), JSON.stringify({comment, time:new Date().toLocaleString('fr-FR'), by:'Op√©rateur'})); }

function renderAlerts(){
  const now=new Date();

  // Trains mis √† quai (en attente de d√©chargement)
  const quaiAlerts = trainsData.filter(t=>t.status==='Mise √† quai').map(t=>{
    const ack=getAck('quai-'+t.id);
    return{type:'warning',icon:'üõ§Ô∏è',trainId:'quai-'+t.id,
      title:`En attente de d√©chargement ‚Äî ${t.train_id}`,
      desc:`${t.cargo} (${t.tonnage}t) | ${t.client} | Mise √† quai confirm√©e`,
      time:'√Ä quai', ack};
  });

  // Alertes critiques (statut Alerte)
  const criticals = trainsData.filter(t=>t.status==='Alerte').map(t=>{
    const ack = getAck(t.id);
    return {type:'critical', icon:'üö®', trainId:t.id,
      title:`Retard signal√© ‚Äî ${t.train_id}`,
      desc:`${t.cargo} (${t.tonnage}t) | ${t.client} | ${t.notes||'Cause inconnue'}`,
      time:'Maintenant', ack};
  });

  // Arriv√©es imminentes
  const warnings = trainsData.filter(t=>{
    const diff=(new Date(t.arrivee)-now)/60000;
    return diff>0&&diff<90&&t.status!=='Arriv√©';
  }).map(t=>{
    const diff=Math.round((new Date(t.arrivee)-now)/60000);
    const ack=getAck('warn-'+t.id);
    return{type:'warning',icon:'‚è∞',trainId:'warn-'+t.id,
      title:`Arriv√©e imminente ‚Äî ${t.train_id}`,
      desc:`${t.cargo} (${t.tonnage}t) pour ${t.client} dans ${diff} min`,
      time:fmtDate(t.arrivee), ack};
  });

  const info = [{type:'info',icon:'‚ÑπÔ∏è',title:'Syst√®me actif',desc:`${trainsData.length} convoi(s) en base ‚Äî Alertes actives`,time:'Syst√®me',ack:null,trainId:null}];
  const items = [...criticals,...quaiAlerts,...warnings,...info];

  document.getElementById('alertsList').innerHTML=`<div class="alerts-list">${items.map(a=>`
    <div class="alert-item ${a.type} ${a.ack?'acked':''}">
      <div class="alert-icon">${a.ack?'‚úÖ':a.icon}</div>
      <div class="alert-text">
        <div class="alert-title" style="${a.ack?'text-decoration:line-through;opacity:.6':''}">
          ${a.title}
          ${a.ack?`<span style="font-family:var(--font-mono);font-size:.6rem;background:rgba(0,153,204,.15);color:var(--accent2);padding:2px 6px;border-radius:3px;margin-left:8px">ACK ${a.ack.time}</span>`:''}
        </div>
        <div class="alert-desc">${a.desc}</div>
        ${a.ack?`<div style="font-family:var(--font-mono);font-size:.7rem;color:var(--accent2);margin-top:4px">üí¨ ${a.ack.comment} ‚Äî ${a.ack.by}</div>`:''}
        ${!a.ack&&a.trainId?`
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center" onclick="event.stopPropagation()">
            <input type="text" id="ack-input-${a.trainId}" placeholder="Commentaire d'acquittement..." 
              style="flex:1;font-size:.75rem;padding:5px 8px;border-radius:3px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:var(--font-body)"
              onkeydown="if(event.key==='Enter')ackAlert('${a.trainId}')">
            <button class="btn" style="font-size:.65rem;padding:5px 10px;border-color:var(--accent2);color:var(--accent2);white-space:nowrap" onclick="ackAlert('${a.trainId}')">‚úì ACQUITTER</button>
          </div>`:''}
      </div>
      <div class="alert-time">${a.time}</div>
    </div>`).join('')}</div>`;
}

function ackAlert(alertId){
  const input = document.getElementById('ack-input-'+alertId);
  const comment = input?.value?.trim()||'Acquitt√© sans commentaire';
  setAck(alertId, comment);
  renderAlerts();
  toast('‚úÖ Alerte acquitt√©e');
}

// Ticker
function renderTicker(){
  const active=trainsData.filter(t=>t.status==='En route'||t.status==='Alerte');
  document.getElementById('tickerText').textContent=active.length?active.map(t=>`‚ñ∂ ${t.train_id} | ${RAILS[t.rail]?.name} | ${t.cargo} ${t.tonnage}t ‚Üí ${fmtDate(t.arrivee)} | ${t.client}`).join('    ///    '):'‚ñ∂ Aucun convoi en circulation';
}

function renderAll(){renderStats();renderRailTimeline();renderCargoChart();renderTonnage();renderTrains();renderAlerts();renderTicker();renderFullTimeline()}

// Tabs
function switchTab(el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-'+el.dataset.tab).classList.add('active');
}

// Modal
function openModal(){
  const n=new Date(),fmt=d=>d.toISOString().slice(0,16);
  document.getElementById('formDepart').value=fmt(n);
  document.getElementById('formArrivee').value=fmt(new Date(n.getTime()+6*3600000));
  document.getElementById('formClient').value='';
  document.getElementById('formNotes').value='';
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open')}

async function addTrain(){
  const depart=document.getElementById('formDepart').value;
  const arrivee=document.getElementById('formArrivee').value;
  if(!depart||!arrivee){toast('Renseignez les dates','error');return}
  if(new Date(arrivee)<=new Date(depart)){toast('Arriv√©e doit √™tre apr√®s d√©part','error');return}
  await api('/api/trains',{method:'POST',body:JSON.stringify({
    rail:document.getElementById('formRail').value,
    cargo:document.getElementById('formCargo').value,
    tonnage:document.getElementById('formTonnage').value,
    client:document.getElementById('formClient').value||'Client inconnu',
    depart,arrivee,
    notes:document.getElementById('formNotes').value
  })});
  closeModal();await loadTrains();toast('‚úÖ Convoi cr√©√© !');
}

async function deleteTrain(id){
  if(!confirm('Supprimer ce convoi ?'))return;
  await api('/api/trains/'+id,{method:'DELETE'});
  await loadTrains();toast('Convoi supprim√©');
}

// Alert config
async function saveAlertConfig(){
  await api('/api/alerts/config',{method:'POST',body:JSON.stringify({
    email:document.getElementById('alertEmail').value,
    delay_min:document.getElementById('alertDelay').value,
    alert_types:document.getElementById('alertTypes').value
  })});
  toast('‚úÖ Config email sauvegard√©e !');
}

async function testAlert(){
  const r=await api('/api/alerts/test',{method:'POST'});
  if(r.error)toast('Erreur: '+r.error,'error');
  else toast('üìß Email de test envoy√© √† '+r.to);
}

// TV mode
let tvMode=false;
function toggleTV(){
  tvMode=!tvMode;
  const aside=document.querySelector('aside');
  const tabs=document.querySelector('.tabs');
  const ticker=document.querySelector('.ticker');
  const layout=document.querySelector('.layout');
  const main=document.querySelector('.main');
  const overview=document.getElementById('tab-overview');
  const tvBtn=document.querySelector('[onclick="toggleTV()"]');

  if(tvMode){
    document.body.requestFullscreen?.();
    // Masquer les √©l√©ments de navigation
    aside.style.display='none';
    tabs.style.display='none';
    ticker.style.display='none';
    // Plein √©cran pour le contenu
    layout.style.gridTemplateColumns='1fr';
    layout.style.height='calc(100vh - 70px)';
    main.style.overflow='hidden';
    // Forcer l'onglet overview
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    overview.classList.add('active');
    overview.style.cssText='display:block;height:100%;overflow-y:auto;padding:32px 48px;';
    // Agrandir pour TV
    document.documentElement.style.fontSize='20px';
    document.getElementById('statsRow').style.cssText='grid-template-columns:repeat(4,1fr);gap:32px;margin-bottom:32px;';
    // Agrandir les blocs rail
    document.querySelectorAll('.track-bar').forEach(b=>b.style.height='44px');
    document.querySelectorAll('.rail-name').forEach(n=>n.style.fontSize='1rem');
    tvBtn.textContent='‚úï QUITTER TV';
    tvBtn.style.borderColor='var(--accent3)';
    tvBtn.style.color='var(--accent3)';
  } else {
    document.exitFullscreen?.();
    aside.style.display='';
    tabs.style.display='';
    ticker.style.display='';
    layout.style.gridTemplateColumns='';
    layout.style.height='';
    main.style.overflow='';
    overview.style.cssText='';
    document.documentElement.style.fontSize='';
    document.getElementById('statsRow').style.cssText='';
    document.querySelectorAll('.track-bar').forEach(b=>b.style.height='');
    document.querySelectorAll('.rail-name').forEach(n=>n.style.fontSize='');
    tvBtn.textContent='üì∫ MODE TV';
    tvBtn.style.borderColor='';
    tvBtn.style.color='';
  }
}

// ‚îÄ‚îÄ D√©tail Convoi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentDetailTrain = null;
// Stockage local des tonnages d√©charg√©s
function getUnloadedKey(id){ return 'railplan-unload-'+id; }
function getUnloaded(id){ return parseFloat(localStorage.getItem(getUnloadedKey(id))||'0'); }
function setUnloaded(id,val){ localStorage.setItem(getUnloadedKey(id), val); }

// SVG Locomotive
function svgLoco(color){
  return`<svg width="110" height="72" viewBox="0 0 110 72" xmlns="http://www.w3.org/2000/svg">
    <!-- Corps principal -->
    <rect x="8" y="18" width="88" height="36" rx="6" fill="${color}"/>
    <!-- Nez avant arrondi -->
    <ellipse cx="96" cy="36" rx="10" ry="18" fill="${color}"/>
    <!-- Cabine -->
    <rect x="12" y="10" width="30" height="20" rx="3" fill="${color}" opacity=".85"/>
    <!-- Vitres cabine -->
    <rect x="15" y="13" width="11" height="10" rx="2" fill="white" opacity=".9"/>
    <rect x="28" y="13" width="11" height="10" rx="2" fill="white" opacity=".9"/>
    <!-- Fen√™tres lat√©rales -->
    <rect x="48" y="22" width="14" height="10" rx="2" fill="white" opacity=".7"/>
    <rect x="66" y="22" width="14" height="10" rx="2" fill="white" opacity=".7"/>
    <!-- Chemin√©e -->
    <rect x="18" y="4" width="8" height="10" rx="2" fill="#444"/>
    <rect x="16" y="2" width="12" height="5" rx="2" fill="#333"/>
    <!-- Fum√©e -->
    <circle cx="22" cy="0" r="3" fill="#888" opacity=".4"/>
    <circle cx="26" cy="-3" r="2" fill="#888" opacity=".25"/>
    <!-- Grille avant -->
    <rect x="90" y="28" width="14" height="16" rx="3" fill="rgba(0,0,0,.3)"/>
    <!-- Phare -->
    <circle cx="100" cy="32" r="3" fill="#ffe066"/>
    <circle cx="100" cy="42" r="3" fill="#ffe066"/>
    <!-- Barre de tamponnement -->
    <rect x="98" y="34" width="8" height="6" rx="1" fill="#555"/>
    <!-- Ch√¢ssis bas -->
    <rect x="6" y="50" width="92" height="6" rx="2" fill="rgba(0,0,0,.25)"/>
    <!-- Roues -->
    <circle cx="22" cy="58" r="10" fill="#222"/>
    <circle cx="22" cy="58" r="6" fill="#444"/>
    <circle cx="22" cy="58" r="2" fill="#aaa"/>
    <circle cx="46" cy="58" r="10" fill="#222"/>
    <circle cx="46" cy="58" r="6" fill="#444"/>
    <circle cx="46" cy="58" r="2" fill="#aaa"/>
    <circle cx="70" cy="58" r="10" fill="#222"/>
    <circle cx="70" cy="58" r="6" fill="#444"/>
    <circle cx="70" cy="58" r="2" fill="#aaa"/>
    <circle cx="90" cy="58" r="8" fill="#222"/>
    <circle cx="90" cy="58" r="5" fill="#444"/>
    <circle cx="90" cy="58" r="2" fill="#aaa"/>
    <!-- Bielle -->
    <line x1="22" y1="58" x2="70" y2="58" stroke="#888" stroke-width="2"/>
  </svg>`;
}

// SVG Wagon marchandise
function svgWagon(color, cargo, loaded, idx){
  const grainColor = {Orge:'#d4a843',Bl√©:'#e8c870',Ma√Øs:'#f0b030',Colza:'#8db54a',Tournesol:'#f5c518'}[cargo]||'#aaa';
  const fillH = loaded ? 22 : 4;
  return`<svg width="72" height="72" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg">
    <!-- Corps wagon -->
    <rect x="4" y="20" width="64" height="32" rx="4" fill="${loaded?color:'#888'}" opacity="${loaded?1:.5}"/>
    <!-- Rebords -->
    <rect x="2" y="18" width="68" height="6" rx="2" fill="${loaded?color:'#777'}"/>
    <rect x="4" y="46" width="64" height="5" rx="2" fill="rgba(0,0,0,.2)"/>
    <!-- Contenu (grain) -->
    ${loaded?`<rect x="6" y="${48-fillH}" width="60" height="${fillH}" rx="2" fill="${grainColor}" opacity=".85"/>
    <ellipse cx="36" cy="${48-fillH}" rx="30" ry="4" fill="${grainColor}"/>` : ''}
    <!-- Num√©ro wagon -->
    <text x="36" y="38" text-anchor="middle" font-family="monospace" font-size="9" fill="white" opacity=".7">${String(idx+1).padStart(2,'0')}</text>
    <!-- Attaches -->
    <rect x="0" y="38" width="6" height="6" rx="1" fill="#555"/>
    <rect x="66" y="38" width="6" height="6" rx="1" fill="#555"/>
    <!-- Ch√¢ssis -->
    <rect x="4" y="50" width="64" height="5" rx="2" fill="rgba(0,0,0,.25)"/>
    <!-- Roues -->
    <circle cx="16" cy="60" r="9" fill="#222"/>
    <circle cx="16" cy="60" r="5" fill="#444"/>
    <circle cx="16" cy="60" r="2" fill="#aaa"/>
    <circle cx="56" cy="60" r="9" fill="#222"/>
    <circle cx="56" cy="60" r="5" fill="#444"/>
    <circle cx="56" cy="60" r="2" fill="#aaa"/>
    <!-- Axe -->
    <line x1="16" y1="60" x2="56" y2="60" stroke="#555" stroke-width="1.5"/>
  </svg>`;
}

function openDetail(trainId){
  const t = trainsData.find(x=>x.id===trainId);
  if(!t) return;
  currentDetailTrain = t;

  const rail = RAILS[t.rail];
  const now = new Date();
  const dep = new Date(t.depart);
  const arr = new Date(t.arrivee);
  const prog = getProgress(t);
  const unloaded = getUnloaded(t.id);
  const unloadPct = Math.min(100, Math.round(unloaded/t.tonnage*100));

  // Header
  document.getElementById('detailId').textContent = t.train_id;
  document.getElementById('detailSubtitle').textContent = rail.name+' ‚Äî '+t.client;

  // Calcul du statut OP√âRATIONNEL r√©el bas√© sur progression + d√©chargement
  function getOperationalStatus(train, unloadPct, prog){
    if(train.status==='Alerte') return {label:'ALERTE', color:'#e05a1e', bg:'rgba(224,90,30,.2)'};
    if(unloadPct>=100)           return {label:'D√âCHARG√â', color:'#4ade80', bg:'rgba(74,222,128,.15)'};
    if(unloadPct>0)              return {label:'EN D√âCHARGEMENT', color:'#00d4aa', bg:'rgba(0,212,170,.15)'};
    if(train.status==='Mise √† quai') return {label:'MISE √Ä QUAI', color:'#f0b030', bg:'rgba(240,176,48,.2)'};
    if(prog>=100)                return {label:'ARRIV√â', color:'#6a8a9a', bg:'rgba(106,138,154,.2)'};
    if(prog>0)                   return {label:'EN ROUTE', color:'#0099cc', bg:'rgba(0,153,204,.2)'};
    return {label:'PLANIFI√â', color:'#d4a843', bg:'rgba(212,168,67,.2)'};
  }
  const opStatus = getOperationalStatus(t, unloadPct, prog);
  const badge = document.getElementById('detailStatusBadge');
  badge.textContent = opStatus.label;
  badge.style.cssText = `background:${opStatus.bg};color:${opStatus.color};border:1px solid ${opStatus.color}`;

  // Sync statut BDD si d√©chargement a commenc√© et statut pas √† jour
  if(unloadPct>0 && unloadPct<100 && t.status!=='En d√©chargement'){
    api('/api/trains/'+t.id,{method:'PUT',body:JSON.stringify({status:'En d√©chargement'})}).then(()=>loadTrains());
  } else if(unloadPct>=100 && t.status!=='Arriv√©'){
    api('/api/trains/'+t.id,{method:'PUT',body:JSON.stringify({status:'Arriv√©'})}).then(()=>loadTrains());
  }

  // Afficher/masquer bouton quai
  setTimeout(()=>{
    const btnQ = document.getElementById('btnQuaiDetail');
    if(btnQ) btnQ.style.display = (t.status==='Arriv√©'||t.status==='Mise √† quai'||t.status==='En d√©chargement') ? 'none' : '';
  },50);

  // Info cards
  const duration = Math.round((arr-dep)/60000);
  const h = Math.floor(duration/60), m = duration%60;
  document.getElementById('detailInfoGrid').innerHTML = `
    <div class="detail-info-card">
      <div class="detail-info-label">üåæ Marchandise</div>
      <div class="detail-info-value">${t.cargo}</div>
      <div class="detail-info-sub">Type de c√©r√©ale</div>
    </div>
    <div class="detail-info-card">
      <div class="detail-info-label">‚öñÔ∏è Tonnage total</div>
      <div class="detail-info-value" style="color:var(--accent2)">${t.tonnage.toLocaleString()} t</div>
      <div class="detail-info-sub">${Math.round(t.tonnage/wagonsCount(t.tonnage))} t / wagon</div>
    </div>
    <div class="detail-info-card">
      <div class="detail-info-label">üë§ Client</div>
      <div class="detail-info-value">${t.client}</div>
      <div class="detail-info-sub">Destinataire</div>
    </div>
    <div class="detail-info-card">
      <div class="detail-info-label">‚è±Ô∏è Dur√©e trajet</div>
      <div class="detail-info-value">${h}h${String(m).padStart(2,'0')}</div>
      <div class="detail-info-sub">Progression : ${prog}%</div>
    </div>`;

  // Train SVG
  const nbWagons = wagonsCount(t.tonnage);
  const wagonsDone = Math.round(unloadPct/100*nbWagons);
  let svgHtml = `<div class="wagon-loco">${svgLoco(rail.color)}</div>`;
  for(let i=0;i<nbWagons;i++){
    const loaded = i >= wagonsDone;
    svgHtml += `<div class="wagon-car ${loaded?'':'unloaded'}">${svgWagon(rail.color, t.cargo, loaded, i)}</div>`;
  }
  document.getElementById('trainSvgContainer').innerHTML = svgHtml;
  document.getElementById('trainRails').style.width = (110 + nbWagons*75 + 32)+'px';
  document.getElementById('wagonLegend').textContent =
    `üöÇ 1 locomotive  +  ${nbWagons} wagons  ¬∑  Charge : ${t.tonnage.toLocaleString()} t  ¬∑  ${wagonsDone} wagon(s) d√©charg√©(s)`;

  // D√©chargement
  document.getElementById('unloadPct').textContent = unloadPct+'%';
  document.getElementById('unloadTons').innerHTML = `<b>${unloaded.toLocaleString()}</b> t d√©charg√©es<br><span style="color:var(--text-dim)">${(t.tonnage-unloaded).toLocaleString()} t restantes</span>`;
  document.getElementById('unloadInput').value = unloaded;
  document.getElementById('unloadInput').max = t.tonnage;
  document.getElementById('unloadMax').textContent = '/ '+t.tonnage.toLocaleString()+'t';
  setTimeout(()=>{ document.getElementById('unloadBar').style.width = unloadPct+'%'; }, 100);

  const isQuaiStatus = t.status==='Mise √† quai'||t.status==='Arriv√©';
  const steps = [
    {icon:'üöÇ', label:'Arriv√©e en gare',
      done: prog>=100||t.status==='Arriv√©'||t.status==='Mise √† quai',
      active: prog>=90&&prog<100},
    {icon:'üõ§Ô∏è', label:'Mise √† quai',
      done: isQuaiStatus||unloadPct>0,
      active: t.status==='Mise √† quai'&&unloadPct===0},
    {icon:'‚öôÔ∏è', label:'D√©chargement',
      done: unloadPct>=100,
      active: unloadPct>0&&unloadPct<100},
    {icon:'‚úÖ', label:'Termin√©',
      done: unloadPct>=100},
  ];
  document.getElementById('unloadSteps').innerHTML = steps.map(s=>`
    <div class="unload-step ${s.done?'done':''} ${s.active?'active':''}">
      <div class="unload-step-icon">${s.icon}</div>
      <div class="unload-step-label">${s.label}</div>
    </div>`).join('');

  // R√©sum√© voyage (sans progression distance)
  document.getElementById('journeyDepart').textContent = fmtDate(t.depart);
  document.getElementById('journeyArrivee').textContent = fmtDate(t.arrivee);
  const nowPct2 = Math.max(0, Math.min(100, (now-dep)/(arr-dep)*100));
  const jLine = document.getElementById('journeyProgressLine');
  const jDot  = document.getElementById('journeyDot');
  if(jLine) jLine.style.width = nowPct2+'%';
  if(jDot){ jDot.style.left = nowPct2+'%'; jDot.style.display = (now>=dep&&now<=arr)?'block':'none'; }

  document.getElementById('detailOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function wagonsCount(tonnage){
  // ~80t par wagon typique c√©r√©alier
  return Math.max(4, Math.min(20, Math.round(tonnage/80)));
}

function saveUnload(){
  if(!currentDetailTrain) return;
  const val = Math.min(currentDetailTrain.tonnage, Math.max(0, parseFloat(document.getElementById('unloadInput').value)||0));
  setUnloaded(currentDetailTrain.id, val);
  openDetail(currentDetailTrain.id);
  toast('‚úÖ D√©chargement mis √† jour');
}

async function setQuai(trainId){
  const t = trainsData.find(x=>x.id===trainId);
  if(!t) return;
  if(!confirm(`Confirmer la mise √† quai de ${t.train_id} ?\nLe statut passera √† "Mise √† quai".`)) return;
  await api('/api/trains/'+trainId,{method:'PUT',body:JSON.stringify({status:'Mise √† quai', notes: t.notes||'Mis √† quai le '+new Date().toLocaleDateString('fr-FR')})});
  await loadTrains();
  toast('üõ§Ô∏è '+t.train_id+' ‚Äî Mise √† quai confirm√©e');
}

function resetUnload(){
  if(!currentDetailTrain) return;
  setUnloaded(currentDetailTrain.id, 0);
  openDetail(currentDetailTrain.id);
  toast('‚Ü∫ D√©chargement r√©initialis√©');
}

async function setQuaiFromDetail(){
  if(!currentDetailTrain) return;
  await setQuai(currentDetailTrain.id);
  // Refresh la page d√©tail
  const updated = trainsData.find(x=>x.id===currentDetailTrain.id);
  if(updated) openDetail(currentDetailTrain.id);
}

function closeDetail(){
  document.getElementById('detailOverlay').classList.remove('open');
  document.body.style.overflow = '';
  currentDetailTrain = null;
}

// Dark mode
function toggleDark(){
  const isDark = document.body.classList.toggle('dark');
  document.getElementById('themeLabel').textContent = isDark ? 'JOUR' : 'NUIT';
  localStorage.setItem('railplan-theme', isDark ? 'dark' : 'light');
}

// Restaurer le th√®me sauvegard√©
(function(){
  if(localStorage.getItem('railplan-theme') === 'dark'){
    document.body.classList.add('dark');
    const lbl = document.getElementById('themeLabel');
    if(lbl) lbl.textContent = 'JOUR';
  }
})();

// Init
(async function init(){
  const cfg=await api('/api/alerts/config');
  if(cfg.email)document.getElementById('alertEmail').value=cfg.email;
  if(cfg.delay_min)document.getElementById('alertDelay').value=cfg.delay_min;
  await loadTrains();
  setInterval(loadTrains,30000);
})();
</script>
</body>
</html>
